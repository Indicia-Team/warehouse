<report
    title="Reference output basic"
    description="Basic output of a reference range calculation for a manually specified bat detector record nights."
    >
  <query>
    select fullset.id, fullset.date_start as night, fullset.passes, round(fullset.percentile*100) as percentile
    from (
      select id, date_start, day_of_year, passes, percent_rank() over (order by passes) as percentile
      from (
        select id, date_start, day_of_year, external_key, passes from ecobat_occurrences o
        where 1=1
        and external_key='#input_taxa_taxon_list_external_key#'
        #filters#
        union
        select -1, null, null, '#input_taxa_taxon_list_external_key#', #input_passes#
        order by id
      ) as o
    ) as fullset
    where fullset.id=-1
  </query>
  <order_bys>
    <order_by>fullset.date_start</order_by>
  </order_bys>
  <params>
    <param name="filter_spatial_km" display="Limit area km" description="Number of km of radius to limit the reference set to." datatype="integer" default="">
      <where>|/ (
        (st_x(st_centroid(st_transform(st_geomfromtext('#input_geom#', 900913), 27700))) - o.easting) ^ 2
        + (st_y(st_centroid(st_transform(st_geomfromtext('#input_geom#', 900913), 27700))) - o.northing) ^ 2
        ) &lt; #filter_spatial_km#*1000</where>
    </param>
    <param name="filter_date" display="Limit day in year" description="Limit to records +/- 30 days of the input" datatype="boolean" default="" >
      <where>
        case
        when extract(doy from '#input_date#'::date) &gt;= 30 and extract(doy from '#input_date#'::date) &lt;= 335 then
        day_of_year &lt;= extract(doy from '#input_date#'::date) + 30 and day_of_year &gt;= extract(doy from '#input_date#'::date) - 30
        when #input_date# &lt; 30 then
        day_of_year &lt;= extract(doy from '#input_date#'::date) + 30 or day_of_year &gt;= extract(doy from '#input_date#'::date) + 365 - 30
        else
        day_of_year &gt;= extract(doy from '#input_date#'::date) - 30 or day_of_year &lt;= extract(doy from '#input_date#'::date) - 365 + 30
        end
      </where>
    </param>
    <param name="filter_temp" display="Limit to similar temperature" description="Limit to records +/- 2deg of the input" datatype="boolean" default="">
      <where>temperature_c between #input_temp#-2 and #input_temp#+2</where>
    </param>
    <param name="filter_wind" display="Limit to similar wind speed" description="Limit to records +/- 2mph of the input" datatype="boolean" default="">
      <where>wind_speed_mph between #input_wind#-2 and #input_wind#+2</where>
    </param>
    <param name="filter_definition_of_pass" display="Limit to same pass definition" description="Limit to records with same definition of pass" datatype="boolean" default="">
      <where>pass_definition_id = #input_pass_definition_id#</where>
    </param>
    <param name="input_taxa_taxon_list_external_key" display="Species external key" description="Preferred external key of the species being input into the report" datatype="text" />
    <param name="input_date" display="Date" description="Date of the record to compare against" datatype="date" default="" />
    <param name="input_passes" display="Passes per night" description="Number of passes being input into the report" datatype="integer" />
    <param name="input_geom" display="Geometry" description="Geometry of site being passed into the report" datatype="text" />
    <param name="input_temp" display="Temperature" description="Temperature at sunset being input into the report in degC" datatype="float" default="-1000" />
    <param name="input_wind" display="Wind speed" description="Wind speed at sunset in mph" datatype="float" default="-1000" />
    <param name="input_pass_definition_id" display="Pass definition" description="Pass definition for record to compare against" datatype="integer" default="" />
  </params>
</report>